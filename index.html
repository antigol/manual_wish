<!DOCTYPE html>
<html lang="en">

<head>

    <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>Wish</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">

    <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/favicon.png">

    <!-- Javascript
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="lib/lint.css">
    <script src="lib/codemirror.js"></script>
    <script src="lib/lint.js"></script>


    <script type="text/javascript">
        function parse(text) {
            errors = [];

            ch = text.length == 0 ? null : text[0];
            k = 0;
            l = 0;
            c = 0;

            vmin = null;
            vmax = null;
            wishes = [];

            vmin_sum = 0;
            vmax_sum = 0;

            function eat() {
                if (ch === "\n") {
                    l++;
                    c = 0;
                } else {
                    c++;
                }
                k++;
                if (k < text.length) {
                    ch = text[k];
                } else {
                    ch = null;
                }
            }

            function eat_line() {
                while (is_space(ch)) {eat();}
                if (ch === "\n") {
                    eat();
                    return;
                }
                if (ch === "#") {
                    skip_line();
                    return;
                }
                if (ch !== null) {
                    eat_row();
                }
            }

            function eat_row() {
                if (!is_digit(ch)) {
                    cc = c;
                    skip_line();
                    errors.push({
                        from: CodeMirror.Pos(l, cc),
                        to: CodeMirror.Pos(l, c),
                        message: "A row must begin with a number"
                    });
                    return;
                }

                row = [];
                x = eat_number();
                if (isNaN(x)) {
                    skip_line();
                    return;
                }
                row.push(x);
                while (is_space(ch)) {eat();}
                while (ch === ",") {
                    cc = c;
                    eat(); // eat the comma
                    while (is_space(ch)) {eat();}

                    if (!is_digit(ch)) {
                        errors.push({
                            from: CodeMirror.Pos(l, cc),
                            to: CodeMirror.Pos(l, c),
                            message: "After a comma, a number is expected"
                        });
                        skip_line();
                        return;
                    }

                    x = eat_number();
                    if (isNaN(x)) {
                        skip_line();
                        return;
                    }
                    row.push(x);
                    while (is_space(ch)) {eat();}
                }

                if (ch === "#") {
                    skip_line();
                }
                if (ch !== "\n" && ch !== null) {
                    cc = c
                    skip_line();
                    errors.push({
                        from: CodeMirror.Pos(l, cc),
                        to: CodeMirror.Pos(l, c),
                        message: "This is not a valid content"
                    });
                    return;
                }

                if (vmin !== null && vmin.length !== row.length) {
                    errors.push({
                        from: CodeMirror.Pos(l, 0),
                        to: CodeMirror.Pos(l, c),
                        message: "All the lines must contain the same amount of values"
                    });
                    return;
                }
                if (vmin === null) {
                    vmin = row;
                    vmin_sum = 0;
                    for (i = 0; i < vmin.length; ++i) {
                        vmin_sum += vmin[i];
                    }
                } else if (vmax === null) {
                    vmax = row;
                    vmax_sum = 0;
                    for (i = 0; i < vmax.length; ++i) {
                        vmax_sum += vmax[i];
                    }
                    for (i = 0; i < vmin.length; ++i) {
                        if (vmax[i] < vmin[i]) {
                            errors.push({
                                from: CodeMirror.Pos(l, 0),
                                to: CodeMirror.Pos(l, c),
                                message: "vmax must be greater or equal than vmin"
                            });
                        }
                    }
                } else {
                    wishes.push(row);
                    if (wishes.length > vmax_sum) {
                        errors.push({
                            from: CodeMirror.Pos(l, 0),
                            to: CodeMirror.Pos(l, c),
                            message: "vmax is too small or there is too much entries"
                        });
                    }
                    tmp = row.slice();
                    tmp.sort();
                    for (i = 0; i < tmp.length; ++i) {
                        if (tmp[i] > i) {
                            errors.push({
                                from: CodeMirror.Pos(l, 0),
                                to: CodeMirror.Pos(l, c),
                                message: "This wish is not fair"
                            });
                            break;
                        }
                    }
                }
            }

            function is_space(ch) {
                return ch === " " || ch === "\t";
            }

            function is_digit(ch) {
                return ch !== null && (ch >= "0" && ch <= "9");
            }

            function eat_number() {
                entry = ch;
                eat();
                while (is_digit(ch)) {
                    entry += ch;
                    eat();
                }
                num = Number(entry);
                if (isNaN(num) || num < 0 || entry[0] === "\n") {
                    errors.push({
                        from: CodeMirror.Pos(l, c - entry.length),
                        to: CodeMirror.Pos(l, c),
                        message: "'"+entry+"' is not a non-negative number"
                    });
                    return NaN;
                }
                return num;
            }

            function skip_line() {
                while (ch !== "\n" && ch !== null) {
                    eat();
                }
            }

            while (ch !== null) {
                eat_line();
            }

            if (wishes.length < vmin_sum) {
                errors.push({
                    from: CodeMirror.Pos(0, 0),
                    to: CodeMirror.Pos(l, c),
                    message: "vmin is too high for the amount of entries"
                });
            }

            res = {
                'vmin': vmin,
                'vmax': vmax,
                'wishes': wishes
            };

            return [res, errors];
        }

        CodeMirror.defineMode("wish_input", function() {
            return {
                startState: function() {
                    return {
                        commentLine: false
                    }
                },
                token: function(stream, state) {
                    if (stream.sol()) {
                        state.commentLine = false;
                    }
                    var ch = stream.next().toString();
                    if (state.commentLine) {
                        return "comment";
                    }
                    if (ch === "#") {
                        state.commentLine = true;
                        return "comment";
                    }
                    if (ch === ",") {
                        return "keyword";
                    }
                    return "atom";
                }
            };
        });

        CodeMirror.registerHelper("lint", "wish_input", function(text) {
            return parse(text)[1];
        });

        function action(wishes, results) {
            score = 0;
            for (i = 0; i < wishes.length; ++i) {
                score += Math.pow(wishes[i][results[i]], 2);
            }
            return score;
        }

        Module = null; // Global application object.
        statusText = 'NO-STATUS';
        inputCode = null;
        outputCode = null;
        data = null;
        best_result = null;
        call_time = 0;

        // Indicate load success.
        function moduleDidLoad() {
            Module = document.getElementById('nacl_module');
            updateStatus('READY');
        }

        function button_pressed() {

            if (statusText === "READY") {
                text = inputCode.getValue();
                out = parse(text);
                console.log(out[0]);
                if (out[1].length == 0) {
                    updateStatus("RUNNING");
                    document.getElementById("button").value = "Stop";
                    data = out[0];
                    best_result = null;
                    Module.postMessage(data);
                    call_time = new Date().getTime();
                }
            } else if (statusText === "RUNNING") {
                updateStatus("READY");
                document.getElementById("button").value = "Search";
                document.getElementById("info").innerHTML = "";
            }
        }

        function handleMessage(message_event) {
            result = message_event.data;

            old_score = best_result === null ? -1 : action(data["wishes"], best_result);
            new_score = action(data["wishes"], result);

            if (new_score < old_score || old_score === -1) {
                old_score = new_score;
                best_result = result;
                text = "# attribution,score\n";
                for (i = 0; i < result.length; ++i) {
                    text += result[i] + "," + data["wishes"][i][result[i]] + "\n";
                }
                outputCode.setValue(text);
            }

            var info = document.getElementById('info')
            var dt = (new Date().getTime() - call_time) / 1000;
            info.innerHTML = Math.round(100 / dt) + " calls by seconds. Best score : " + old_score;

            if (statusText === "RUNNING") {
                Module.postMessage(data);
                call_time = new Date().getTime();
            }
        }

        function pageDidLoad() {
            if (Module == null) {
                updateStatus('LOADING...');
            } else {
                updateStatus();
            }

            inputCode = CodeMirror.fromTextArea(document.getElementById('input'), {
                lineNumbers: true,
                mode: "wish_input",
                gutters: ["CodeMirror-lint-markers"],
                lint: true
            });
            outputCode = CodeMirror.fromTextArea(document.getElementById('output'), {
                lineNumbers: true,
                readOnly: true
            });
        }

        function updateStatus(opt_message) {
            if (opt_message)
                statusText = opt_message;
            var statusField = document.getElementById('statusField');
            if (statusField) {
                statusField.innerHTML = statusText;
            }
        }
    </script>
</head>

<body onload="pageDidLoad()">

    <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="container">
        <div class="row" style="margin-top: 5%">
            <h1>Wish</h1>
        </div>
        <div class="row">
            This page uses NaCl. It works only on Chrome web browser.
        </div>
        <div class="row">
            <div class="one-half column">
                Input
                <textarea id="input" rows="10" cols="60">16,16,16,16,16,16,16,16,16,16 # vmin
18,18,18,18,18,18,18,18,18,18 # vmax
2,0,9,8,7,5,6,1,4,3 # student 1
2,1,3,7,8,5,0,9,6,4 # student 2
8,0,6,4,5,1,7,3,9,2 # etc...
2,0,7,3,6,4,5,1,9,8
2,1,7,3,9,0,6,5,8,4
6,9,4,8,5,7,3,2,0,1
2,9,8,5,4,3,6,1,0,7
4,9,3,8,5,6,1,0,2,7
5,4,3,7,9,8,0,2,1,6
5,1,3,4,8,9,0,2,7,6
4,1,9,5,3,6,0,2,8,7
5,4,6,3,8,9,0,2,1,7
9,4,3,2,1,7,5,0,6,8
0,1,4,3,5,8,6,2,9,7
2,6,8,9,3,1,7,0,4,5
2,3,0,8,6,7,9,1,5,4
1,2,5,3,8,9,6,7,0,4
6,0,5,7,1,9,2,3,8,4
7,3,1,6,5,0,8,4,9,2
9,0,3,4,5,2,7,1,8,6
4,9,3,5,6,8,7,0,1,2
4,6,3,8,1,7,0,2,5,9
0,9,5,8,1,6,7,3,4,2
1,4,7,3,9,8,2,0,6,5
0,7,8,6,5,9,1,3,4,2
6,9,2,7,3,4,8,0,1,5
0,1,8,6,5,9,4,2,3,7
3,8,2,6,7,9,1,4,5,0
2,4,5,6,8,9,3,0,1,7
1,4,3,9,7,8,6,0,2,5
1,9,0,3,5,7,6,2,4,8
4,6,5,9,7,8,3,0,1,2
5,8,4,6,7,9,2,1,0,3
5,6,3,7,4,2,1,0,8,9
5,0,7,2,4,6,8,1,9,3
3,1,9,7,8,5,0,2,4,6
2,1,8,0,6,9,5,3,4,7
9,5,0,8,3,4,2,1,6,7
3,5,1,4,9,6,2,0,7,8
7,9,1,8,6,5,2,0,3,4
3,5,0,9,2,8,6,1,4,7
5,2,1,9,8,7,6,3,0,4
5,0,7,2,4,6,8,1,9,3
3,1,9,7,8,5,0,2,4,6
7,6,4,9,5,8,1,0,3,2
6,9,8,7,3,5,1,0,2,4
0,9,3,4,7,8,5,2,1,6
6,7,3,8,5,9,0,4,1,2
8,9,6,3,5,7,1,2,0,4
0,9,5,6,2,8,3,1,4,7
9,4,6,7,3,2,5,0,8,1
3,4,5,6,8,9,0,2,1,7
0,5,9,1,8,6,7,2,3,4
0,4,2,9,5,3,7,6,8,1
3,9,8,7,6,5,2,1,0,4
6,3,4,8,7,9,0,2,5,1
4,9,1,0,8,3,7,5,6,2
3,8,5,7,4,9,0,1,2,6
7,3,0,8,9,5,4,2,6,1
7,1,4,8,9,6,0,5,3,2
7,9,2,8,5,4,3,0,6,1
1,9,5,6,8,3,7,4,0,2
7,0,6,3,1,5,8,4,9,2
3,0,7,9,8,6,2,4,5,1
3,9,2,8,6,5,0,4,1,7
2,0,6,5,9,3,7,4,8,1
7,0,3,4,1,5,8,9,6,2
0,9,1,2,5,8,7,4,3,6
2,5,7,6,8,4,0,3,1,9
7,4,0,8,6,1,9,3,2,5
4,8,0,9,3,7,5,1,2,6
4,0,8,5,9,6,3,2,7,1
3,0,5,9,4,2,1,7,8,6
1,7,9,5,8,6,0,2,4,3
7,3,4,8,5,9,0,2,1,6
8,7,9,0,5,4,1,6,3,2
9,0,2,7,6,3,1,4,8,5
3,9,4,1,6,8,0,2,5,7
8,6,3,2,0,7,5,1,9,4
7,0,6,3,5,9,1,2,4,8
3,0,5,9,7,4,8,2,1,6
4,9,5,8,3,6,0,2,1,7
1,4,6,9,8,5,3,2,0,7
5,7,0,3,8,9,1,4,6,2
1,0,7,6,5,9,4,3,2,8
4,0,7,9,6,2,3,5,1,8
4,0,8,5,3,6,9,1,2,7
8,0,4,2,7,9,1,3,6,5
5,0,4,1,6,7,2,3,8,9
0,9,5,8,6,7,4,2,1,3
4,1,8,3,9,7,0,6,2,5
4,0,9,2,8,6,1,5,3,7
2,0,9,5,7,6,1,4,8,3
4,8,1,9,6,3,7,5,2,0
5,0,6,7,3,8,2,1,4,9
7,0,9,1,8,5,2,6,4,3
9,0,5,8,7,6,1,3,2,4
5,0,4,9,6,8,3,1,2,7
4,0,9,3,6,5,8,1,7,2
0,2,4,6,8,7,9,5,1,3
2,8,4,3,6,9,7,0,5,1
5,0,9,4,6,8,3,1,2,7
6,0,1,7,2,9,4,8,5,3
6,0,8,7,3,9,2,1,4,5
4,0,1,5,3,7,6,2,8,9
4,9,7,5,6,8,0,2,3,1
6,9,4,8,5,7,3,1,2,0
2,9,6,8,3,7,5,4,0,1
5,9,2,8,4,6,7,1,3,0
1,9,7,8,3,6,0,2,4,5
3,9,4,8,6,7,0,2,1,5
9,8,4,7,2,6,3,0,5,1
3,9,4,8,6,7,0,1,2,5
2,9,7,8,4,3,5,0,1,6
7,9,3,8,2,4,1,6,0,5
0,9,4,5,2,6,8,1,7,3
1,9,3,8,2,7,6,0,4,5
3,7,0,9,1,6,4,2,5,8
4,6,7,8,1,9,2,0,3,5
3,5,7,6,4,9,0,8,1,2
8,1,9,5,6,3,0,2,7,4
8,1,0,3,5,7,6,4,9,2
0,1,4,2,8,9,6,5,3,7
5,4,2,9,8,3,1,0,6,7
8,0,7,3,9,6,2,4,5,1
5,8,9,4,1,3,6,0,7,2
1,2,4,7,9,8,0,5,3,6
1,0,6,9,7,8,3,2,4,5
8,4,0,9,5,6,1,2,7,3
1,6,4,9,3,7,8,0,5,2
6,9,2,8,4,5,3,0,7,1
1,6,7,5,9,8,0,2,3,4
9,6,5,7,8,1,3,0,4,2
5,8,9,4,1,3,6,0,7,2
3,6,7,8,5,4,0,1,2,9
4,7,8,5,3,9,0,1,6,2
0,9,2,6,5,7,4,1,3,8
9,4,2,7,1,8,6,0,5,3
3,9,0,6,8,2,4,1,7,5
2,6,8,7,0,9,5,1,4,3
3,9,1,8,4,2,6,5,0,7
8,2,0,9,5,4,1,6,7,3
5,8,9,3,6,7,2,0,1,4
6,7,1,5,9,4,8,2,3,0
7,6,8,4,5,9,0,1,2,3
3,7,0,9,5,6,2,1,4,8
4,9,3,6,7,8,5,0,1,2
2,5,1,4,6,8,7,3,9,0
4,3,5,8,6,7,9,0,1,2
7,5,0,6,4,2,9,1,3,8
1,4,9,6,8,7,2,3,5,0
6,9,2,4,3,7,8,0,5,1
2,9,8,7,5,6,3,1,4,0
7,4,2,6,1,9,8,0,5,3
5,9,6,8,3,7,2,0,4,1
4,9,2,6,0,8,7,1,5,3
4,9,2,6,0,8,7,1,5,3
6,8,2,7,1,9,4,0,5,3
3,9,2,8,1,7,4,0,5,6
2,9,7,6,5,3,4,0,1,8
3,9,2,8,0,7,4,1,5,6
7,4,5,6,2,8,0,3,9,1
7,9,5,6,2,8,1,3,4,0
2,0,5,9,6,7,1,8,3,4
6,7,8,9,2,5,1,3,4,0
4,9,2,6,0,8,7,1,5,3</textarea>
            </div>
            <div class="one-half column">
                Output
                <textarea id="output" rows="10" cols="60"></textarea>
            </div>
        </div>
        <div class="row">
            <input id="button" class="button-primary u-full-width" type="button" onclick="button_pressed()" value="Search">
        </div>
        <div class="row">
            <div class="one-half column">
                <p>Status <code id="statusField">NO-STATUS</code></p>
            </div>
            <div class="one-half column">
                <div id="info"></div>
            </div>
        </div>
    </div>

    <div id="listener">
        <script type="text/javascript">
            var listener = document.getElementById('listener');
            listener.addEventListener('load', moduleDidLoad, true);
            listener.addEventListener('message', handleMessage, true);
        </script>

        <embed id="nacl_module" width="0" height="0" src="wish.nmf" type="application/x-pnacl" />
    </div>

    <!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>

</html>
